let results = [];

msg.payload.forEach(product => {
    let warnings = [];
    let statusLevel = "normal"; // normal | warning | critical

    const now = new Date();
    const expiry = new Date(product.expiry_date);

    // Son kullanma tarihi kontrolÃ¼
    if (expiry < now) {
        warnings.push("âŒ Son kullanma tarihi geÃ§ti!");
        statusLevel = "critical";
    } else {
        const daysLeft = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
        if (daysLeft <= 2) {
            warnings.push(`âš ï¸ Son kullanma tarihine ${daysLeft} gÃ¼n kaldÄ±.`);
            if (statusLevel !== "critical") statusLevel = "warning";
        }
    }

    // SÄ±caklÄ±k kontrolÃ¼
    if (product.temperature < 1 || product.temperature > 8) {
        warnings.push(`ğŸŒ¡ï¸ SÄ±caklÄ±k uygun deÄŸil: ${product.temperature}Â°C`);
        if (statusLevel !== "critical") statusLevel = "warning";
        if (product.temperature < -5 || product.temperature > 25) {
            statusLevel = "critical";
        }
    }

    // Nem kontrolÃ¼
    if (product.humidity < 50 || product.humidity > 90) {
        warnings.push(`ğŸ’§ Nem seviyesi dengesiz: %${product.humidity}`);
        if (statusLevel !== "critical") statusLevel = "warning";
    }

    // EÄŸer hiÃ§bir sorun yoksa durum normal
    if (warnings.length === 0) {
        warnings.push("âœ… Durum normal");
    }

    // ÃœrÃ¼n durumunu ve sÄ±nÄ±flandÄ±rmasÄ±nÄ± ekle
    const productStatus = {
        product_id: product.product_id,
        product_name: product.product_name,
        quantity: product.quantity,
        expiry_date: product.expiry_date,
        temperature: product.temperature,
        humidity: product.humidity,
        status: statusLevel,
        warnings: warnings
    };

    results.push(productStatus);

    // Log Ã§Ä±ktÄ±sÄ±
    const logHeader = {
        "critical": "ğŸ”´ [KRÄ°TÄ°K DURUM]",
        "warning": "ğŸŸ¡ [DÄ°KKAT]",
        "normal": "ğŸŸ¢ [NORMAL]"
    }[statusLevel];

    const logMessage = `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${logHeader}
ğŸ“¦ ÃœrÃ¼n: ${product.product_name} (${product.product_id})
ğŸ“… Son Kullanma Tarihi: ${product.expiry_date}
ğŸŒ¡ï¸ SÄ±caklÄ±k: ${product.temperature}Â°C
ğŸ’§ Nem: %${product.humidity}
ğŸ” Durum:
- ${warnings.join("\n- ")}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    `.trim();

    if (statusLevel === "critical") {
        node.error(logMessage);
    } else if (statusLevel === "warning") {
        node.warn(logMessage);
    } else {
        node.log(logMessage);
    }
});

msg.payload = results;
return msg;
